name: Android Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Fix Android SDK issue
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_HOME/ndk" >> local.properties
    
    - name: Create file_paths.xml
      run: |
        mkdir -p app/src/main/res/xml
        # Простое создание без HEREDOC
        echo '<?xml version="1.0" encoding="utf-8"?>' > app/src/main/res/xml/file_paths.xml
        echo '<paths xmlns:android="http://schemas.android.com/apk/res/android">' >> app/src/main/res/xml/file_paths.xml
        echo '    <external-files-path name="secret_gallery" path="Pictures" />' >> app/src/main/res/xml/file_paths.xml
        echo '</paths>' >> app/src/main/res/xml/file_paths.xml
        echo "✅ file_paths.xml создан"
    
    - name: Setup Gradle
      run: |
        mkdir -p build/reports/problems
        cat > gradle.properties << 'EOF'
org.gradle.configuration-cache=false
gradle.problems.reports.directory=/tmp
systemProp.gradle.problems.reports.directory=/tmp
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
android.useAndroidX=true
kotlin.code.style=official
EOF
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Clean previous builds
      run: |
        ./gradlew clean 2>/dev/null || true
    
    - name: Build APK (force)
      id: build
      continue-on-error: true
      run: |
        set +e
        ./gradlew assembleDebug --no-build-cache --warning-mode none 2>&1 | tee build.log
        
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "✅ APK СОЗДАН!"
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "❌ APK НЕ СОЗДАН"
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Upload APK if exists
      if: steps.build.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: clean-cache-app
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
    
    - name: Upload debug info
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info
        path: |
          build.log
          app/build/reports/
        if-no-files-found: ignore

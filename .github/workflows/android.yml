name: Android Build

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Fix Android SDK issue
      run: |
        # Создаём local.properties с правильным SDK путём
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "ndk.dir=$ANDROID_HOME/ndk" >> local.properties
        echo "Android SDK установлен в: $ANDROID_HOME"
    
    - name: Create required directories
      run: |
        # Создаём папки которые требуются
        mkdir -p app/src/main/res/xml
        mkdir -p build/reports/problems
        
        # Создаём file_paths.xml если нет
        if [ ! -f "app/src/main/res/xml/file_paths.xml" ]; then
          cat > app/src/main/res/xml/file_paths.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <external-files-path name="secret_gallery" path="Pictures" />
</paths>
EOF
          echo "✅ file_paths.xml создан"
        fi
        
        # Создаём gradle.properties
        cat > gradle.properties << EOF
org.gradle.configuration-cache=false
gradle.problems.reports.directory=/tmp
systemProp.gradle.problems.reports.directory=/tmp
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
android.useAndroidX=true
kotlin.code.style=official
EOF
    
    - name: Make gradlew executable
      run: chmod +x ./gradlew
    
    - name: Clean previous builds
      run: |
        ./gradlew clean 2>/dev/null || true
        rm -rf ~/.gradle/caches/ 2>/dev/null || true
    
    - name: Build APK (force)
      id: build
      continue-on-error: true
      run: |
        set +e
        
        # Игнорируем предупреждения
        export GRADLE_OPTS="-Dgradle.problems.reports.directory=/tmp"
        
        # Собираем APK
        ./gradlew assembleDebug --no-build-cache --warning-mode none 2>&1 | tee build.log
        
        # Проверяем создался ли APK несмотря на ошибки
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "✅ APK СОЗДАН УСПЕШНО!"
          echo "APK путь: app/build/outputs/apk/debug/app-debug.apk"
          echo "Размер: $(stat -c%s app/build/outputs/apk/debug/app-debug.apk) байт"
          echo "apk_exists=true" >> $GITHUB_OUTPUT
          exit 0  # Успех даже если Gradle ругался
        else
          echo "❌ APK НЕ СОЗДАН"
          echo "=== ПОСЛЕДНИЕ ОШИБКИ ==="
          tail -50 build.log | grep -A10 -B10 "error\|ERROR\|FAILED"
          echo "apk_exists=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    - name: Debug if failed
      if: steps.build.outputs.apk_exists == 'false'
      run: |
        echo "=== ДЕТАЛЬНАЯ ДИАГНОСТИКА ==="
        echo "1. Проверка структуры проекта:"
        find . -name "*.xml" -path "*/res/*" | grep -v build
        
        echo "2. Проверка манифеста:"
        grep -n "file_paths" app/src/main/AndroidManifest.xml
        
        echo "3. Проверка темы:"
        find . -name "themes.xml" -type f | xargs cat 2>/dev/null || echo "themes.xml не найден"
        
        echo "4. Ошибки сборки:"
        ./gradlew assembleDebug --stacktrace 2>&1 | tail -100
    
    - name: Upload APK if exists
      if: steps.build.outputs.apk_exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: clean-cache-app
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
    
    - name: Upload debug info
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info
        path: |
          build.log
          app/build/reports/
          gradle.properties
        if-no-files-found: ignore
        retention-days: 7
